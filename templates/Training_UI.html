<!DOCTYPE html>
{% extends "base.html" %}

{% block title %}Recommended Training{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/training.css') }}">
{% endblock %}

{% block content %}
<div class="container mx-auto p-4 sm:p-6 md:p-8 max-w-4xl">
    <main class="bg-white rounded-2xl shadow-lg p-6 md:p-8">
        <div id="user-profile-xai" class="mb-8 p-6 bg-blue-50 border-l-4 border-blue-500 rounded-r-lg">
            <div class="flex items-start sm:items-center space-x-4">
                <img id="training-user-avatar" src="https://placehold.co/80x80/E2E8F0/4A5568?text=User" alt="User Profile" class="w-16 h-16 sm:w-20 sm:h-20 rounded-full border-2 border-white shadow-md" onerror="this.onerror=null;this.src='https://placehold.co/80x80/E2E8F0/4A5568?text=U';">
                <div>
                    <h2 id="training-user-name" class="text-xl font-bold text-slate-800">Juan Dela Cruz</h2>
                    <p id="training-user-role" class="text-sm text-slate-600">Aspiring Full-Stack Developer</p>
                    <p id="training-user-group" class="text-xs text-slate-500 mt-1">Group: FoodCast</p>
                </div>
            </div>
            <div class="mt-4">
                <h3 class="font-semibold text-slate-900">Why These Recommendations?</h3>
                <p class="text-sm text-slate-700 mt-1">
                    Our AI has selected these training programs for you based on the following profile information:
                </p>
                <ul class="mt-2 space-y-1 text-sm list-disc list-inside text-slate-600">
                    <li id="xai-skills"><strong>Your Skills:</strong> <span>Loading...</span></li>
                    <li id="xai-interests"><strong>Your Interests:</strong> <span>Loading...</span></li>
                    <li id="xai-goals"><strong>Your Career Goals:</strong> <span>Loading...</span></li>
                </ul>
            </div>
        </div>

        <div id="loader" class="mt-8 flex items-center justify-center">
            <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12"></div>
        </div>

        <div id="training-container" class="mt-8 hidden">
             <h2 class="text-2xl font-bold text-slate-900 mb-4">Recommended For You</h2>
            <div id="training-list" class="space-y-4">
                </div>
        </div>
            <a id="careerSimulationBtn" href="/matchmaking" class="mt-6 w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition text-center block">
                Back
            </a>
    </main>
</div>

<div id="trainingPopupOverlay" class="training-popup-overlay">
    <div class="training-popup">
        <span class="close-popup">&times;</span>
        <div id="trainingPopupContent" class="space-y-4">
            </div>
        <div class="mt-6 flex flex-col sm:flex-row gap-4">
            <a id="enrollBtn" href="#" target="_blank" class="flex-1 text-center bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition">
                Enroll Now
            </a>
            <button id="saveForLaterBtn" class="flex-1 border border-blue-600 text-blue-600 hover:bg-blue-50 font-semibold py-2 px-4 rounded-lg transition">
                Save for Later
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const loader = document.getElementById('loader');
        const trainingContainer = document.getElementById('training-container');
        const trainingList = document.getElementById('training-list');
        
        const xaiSkills = document.querySelector('#xai-skills span');
        const xaiInterests = document.querySelector('#xai-interests span');
        const xaiGoals = document.querySelector('#xai-goals span');

        const nameEl = document.getElementById('training-user-name');
        const roleEl = document.getElementById('training-user-role');
        const groupEl = document.getElementById('training-user-group');
        const avatarEl = document.getElementById('training-user-avatar');

        const trainingPopupOverlay = document.getElementById('trainingPopupOverlay');
        const trainingPopupContent = document.getElementById('trainingPopupContent');
        const closePopupButtons = document.querySelectorAll('.close-popup');

        // fallback/mock profile (used when no local profile found)
        const fallbackProfile = {
            fullName: "Juan Dela Cruz",
            course: "Aspiring Full-Stack Developer",
            skills: "JavaScript, Python, Data Analysis, Graphic Design",
            interests: "Web Development, technology trends, freelancing",
            careerGoals: "Become a full-stack developer, work remotely"
        };

        // Training program recommendations (unchanged)
        const recommendedPrograms = [
            {
                "program_name": "Full-Stack Web Development NC III",
                "description": "A comprehensive TESDA program covering both front-end and back-end technologies to build complete web applications. Aligns with your goal to become a full-stack developer.",
                "provider": "TESDA",
                "link": "https://e-tesda.gov.ph/",
                "details": ["HTML/CSS/JS mastery", "Server-side scripting", "Database management", "Full project lifecycle"],
                "duration": "280 hours",
                "requirements": "High school diploma or ALS certificate",
                "certification": "TESDA National Certificate III"
            },
            {
                "program_name": "Python for Data Science",
                "description": "This course from DICT focuses on Python's data analysis libraries (like Pandas and NumPy), leveraging your existing Python and Data Analysis skills for a high-demand field.",
                "provider": "DICT - DigitalJobsPH",
                "link": "https://governmentph.com/digitaljobsph-dict/",
                "details": ["Data manipulation with Pandas", "Data visualization", "Machine learning basics", "Statistical analysis"],
                "duration": "40 hours",
                "requirements": "Basic Python knowledge",
                "certification": "Certificate of Completion"
            },
            {
                "program_name": "Advanced JavaScript for Remote Work",
                "description": "Deepen your JavaScript knowledge with modern frameworks (like React or Vue) essential for remote development roles, matching your interest in freelancing and remote work.",
                "provider": "Coursera",
                "link": "https://www.coursera.org/?msockid=15cc3b7ea72463880a932d5da6306295",
                "details": ["Asynchronous programming", "Modern JS frameworks (React)", "State management", "API integration"],
                "duration": "6-8 weeks",
                "requirements": "Intermediate JavaScript knowledge",
                "certification": "Coursera Professional Certificate"
            },
            {
                "program_name": "UI/UX Design for Developers",
                "description": "Leverage your Graphic Design skill to improve your web development projects. This course teaches design principles from a developer's perspective.",
                "provider": "https://www.udemy.com/",
                "link": "#",
                "details": ["User research basics", "Wireframing & prototyping", "Usability testing", "Design principles for developers"],
                "duration": "15 hours (self-paced)",
                "requirements": "None",
                "certification": "Udemy Certificate of Completion"
            }
        ];

        // try to read local profile from localStorage (profileDraft)
        function loadLocalProfile() {
            try {
                const raw = localStorage.getItem('profileDraft');
                if (!raw) return null;
                const saved = JSON.parse(raw);
                return saved;
            } catch (e) {
                console.warn('Failed to parse local profile:', e);
                return null;
            }
        }

        // normalize profile fields for this page
        function normalizeProfile(saved) {
            if (!saved) return fallbackProfile;
            const skills = Array.isArray(saved.skills) ? saved.skills.join(', ') :
                           (typeof saved.skills === 'string' ? saved.skills : '');
            const interests = saved.interests || saved.interest || saved.interestsList || '';
            const careerGoals = saved.careerGoals || saved.goals || '';
            const fullName = saved.fullName || saved.name || saved.fullname || fallbackProfile.fullName;
            const course = saved.course || saved.degree || fallbackProfile.course;
            return {
                fullName,
                course,
                skills,
                interests,
                careerGoals
            };
        }

        function displayTrainingPrograms(profile) {
            // Populate the XAI section
            xaiSkills.textContent = profile.skills || 'No skills listed';
            xaiInterests.textContent = profile.interests || 'No interests listed';
            xaiGoals.textContent = profile.careerGoals || 'No career goals listed';

            // update header info
            nameEl.textContent = profile.fullName || fallbackProfile.fullName;
            roleEl.textContent = profile.course || fallbackProfile.course;
            // remove group if not available
            if (!profile.group) {
                groupEl.style.display = 'none';
            }

            // Clear any previous list items
            trainingList.innerHTML = '';

            if (Array.isArray(recommendedPrograms) && recommendedPrograms.length > 0) {
                recommendedPrograms.forEach(program => {
                    const card = document.createElement('div');
                    card.className = 'bg-slate-100 p-4 rounded-lg shadow-sm transition-transform transform hover:scale-[1.02] cursor-pointer training-card';
                    card.innerHTML = `
                        <h3 class="font-semibold text-lg text-slate-900">${program.program_name}</h3>
                        <p class="mt-1 text-sm text-slate-500">Provider: ${program.provider}</p>
                        <p class="mt-2 text-slate-700">${program.description}</p>
                    `;
                    card.addEventListener('click', () => showTrainingPopup(program));
                    trainingList.appendChild(card);
                });
                trainingContainer.classList.remove('hidden');
            } else {
                trainingList.innerHTML = '<p class="text-slate-500">No training programs are currently available.</p>';
            }
            
            loader.classList.add('hidden');
        }

        function showTrainingPopup(program) {
            const detailsList = program.details.map(item => `<li class="text-slate-700">${item}</li>`).join('');

            trainingPopupContent.innerHTML = `
                <h3 class="text-2xl font-bold text-slate-900 mb-2">${program.program_name}</h3>
                <p class="text-sm text-slate-600 mb-4">Provider: <span class="font-medium text-slate-800">${program.provider}</span></p>
                <p class="text-slate-700">${program.description}</p>

                <div class="mt-4 border-t border-slate-200 pt-4">
                    <h4 class="font-semibold text-slate-900 mb-2">What you'll learn:</h4>
                    <ul class="list-disc list-inside space-y-1">
                        ${detailsList}
                    </ul>
                </div>
                
                <div class="mt-4 grid grid-cols-2 gap-4 text-sm text-slate-600">
                    <div>
                        <span class="font-semibold text-slate-900">Duration:</span>
                        <p>${program.duration}</p>
                    </div>
                    <div>
                        <span class="font-semibold text-slate-900">Requirements:</span>
                        <p>${program.requirements}</p>
                    </div>
                    <div class="col-span-2">
                        <span class="font-semibold text-slate-900">Certification:</span>
                        <p>${program.certification}</p>
                    </div>
                </div>
            `;
            
            const enrollBtn = document.getElementById('enrollBtn');
            if (enrollBtn) {
                enrollBtn.href = program.link;
            }

            trainingPopupOverlay.classList.add('active');
        }

        function closePopup() {
            trainingPopupOverlay.classList.remove('active');
        }

        // Initialize display using local profile if present
        const savedProfile = loadLocalProfile();
        const profile = normalizeProfile(savedProfile);
        displayTrainingPrograms(profile);

        // Event listeners for popups
        closePopupButtons.forEach(btn => {
            btn.addEventListener('click', closePopup);
        });
        
        window.addEventListener('click', (e) => {
            if (e.target === trainingPopupOverlay) {
                closePopup();
            }
        });
    });
</script>
{% endblock %}